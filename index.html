<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>åŒæœŸã‚¿ã‚¤ãƒãƒ¼</title>
  <style>
    :root{
      --bg:#0b0c10; --fg:#e6e6e6; --accent-play:#1db954; --accent-setup:#ffb020;
      --muted:#9aa0a6; --card:#0f1218; --danger:#ff4d4f; --frame:#222531;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;
      background:radial-gradient(1200px 800px at 50% -10%,#151a20 0%,var(--bg) 60%);
      color:var(--fg);
      display:grid; place-items:center; padding:8px;
    }
    .app{width:100%; max-width:1800px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    header h1{font-size:16px;font-weight:700;margin:0;color:#cbd5e1;letter-spacing:.02em}
    .adminbar{display:flex;gap:8px;align-items:center}
    .muted{color:var(--muted);font-size:12px}
    button{font:inherit;padding:10px 14px;border-radius:12px;background:#1a1f2b;color:#e5e7eb;border:1px solid #283042;cursor:pointer}
    button:hover{filter:brightness(1.05)} button:disabled{opacity:.5;cursor:not-allowed}
    .btn-ghost{background:transparent;border-color:#2b3040}
    .btn-primary{background:#22314d;border-color:#2b3c5f}
    .btn-danger{background:#351a1a;border-color:#5a2525;color:#ffb3b3}

    .timer{
      background:var(--card); border:1px solid var(--frame); border-radius:24px; padding:20px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      /* ã»ã¼å…¨é¢ã‚’ä½¿ã†é«˜ã•ï¼ˆsvh ã¯ãƒ¢ãƒã‚¤ãƒ«ã®UIã‚’é™¤ã„ãŸçŸ­è¾ºåŸºæº– / vh ä½µè¨˜ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ */
      min-height:min(82svh, 82vh);
      display:grid; gap:6px;
    }

    /* ====== ã§ã‹ãƒãƒƒã‚¸ï¼ˆæ¼”å¥ä¸­/è»¢æ›ä¸­ï¼‰ ====== */
    .badge{
      display:inline-flex; align-items:center; gap:10px; border-radius:9999px; font-weight:900; letter-spacing:.02em;
      /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚‚æµå‹•çš„ã«å·¨å¤§åŒ– */
      padding: clamp(8px, 1.3vmin, 28px) clamp(14px, 2.6vmin, 48px);
      /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºï¼šæœ€å°24pxã€ç†æƒ³ 5.5vminã€æœ€å¤§ 64px */
      font-size: clamp(24px, 5.5vmin, 64px);
    }
    .badge.play{background:color-mix(in hsl,var(--accent-play) 20%,transparent);color:var(--accent-play);border:1px solid color-mix(in hsl,var(--accent-play) 50%,transparent)}
    .badge.setup{background:color-mix(in hsl,var(--accent-setup) 20%,transparent);color:var(--accent-setup);border:1px solid color-mix(in hsl,var(--accent-setup) 50%,transparent)}

    /* ====== å·¨å¤§ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ ====== */
    .time{
      font-variant-numeric:tabular-nums;
      text-align:center; font-weight:1000; line-height:.92;
      /* ç”»é¢ã®çŸ­è¾ºåŸºæº–ã§æ¥µå¤§åŒ–ï¼ˆæœ€å°180pxãƒ»ç†æƒ³ 36vminãƒ»æœ€å¤§ 80vminï¼‰ */
      font-size: clamp(180px, 36vmin, 80vmin);
      letter-spacing:.02em; margin:8px 0 6px;
      text-shadow: 0 0 2px rgba(0,0,0,.6);
    }

    /* æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºè¡¨ç¤ºã‚‚å¤§ãã‚ã« */
    .sub{
      text-align:center; color:var(--muted);
      font-size: clamp(18px, 3.6vmin, 42px);
    }

    /* ====== ç®¡ç†UIï¼ˆç®¡ç†è€…ONã®æ™‚ã ã‘å‡ºã™ï¼‰ ====== */
    .panel{margin-top:14px;display:grid;gap:12px}
    .card{background:#0c1016;border:1px solid var(--frame);border-radius:16px;padding:16px}
    .card h3{margin:0 0 8px;font-size:14px;color:#cbd5e1}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .field{display:grid;gap:6px}
    .field label{font-size:12px;color:var(--muted)}
    .field input[type="number"]{padding:10px 12px;border-radius:10px;border:1px solid #2b3040;background:#0c0f14;color:#fff}
    .switch{display:flex;align-items:center;gap:8px}

    /* ãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.4);padding:16px;z-index:50}
    .modal .sheet{width:min(520px,100%);background:#0f1218;border:1px solid var(--frame);border-radius:16px;padding:16px}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>åŒæœŸã‚¿ã‚¤ãƒãƒ¼</h1>
      <div class="adminbar">
        <span id="authState" class="muted">ğŸ”’ ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰: OFF</span>
        <button id="fullscreenBtn" class="btn-ghost" title="ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ (F)">ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³</button>
        <button id="loginBtn" class="btn-ghost">åˆè¨€è‘‰ã§ç®¡ç†è€…ON</button>
        <button id="logoutBtn" class="btn-ghost" style="display:none">ç®¡ç†è€…OFF</button>
      </div>
    </header>

    <div class="timer">
      <div id="phaseBadge" class="badge play">æ¼”å¥ä¸­</div>
      <div id="timeText" class="time">15:00</div>
      <div id="subText" class="sub">æ¬¡: è»¢æ› (5:00) ï¼ é–‹å§‹äºˆå®š: â€”</div>

      <!-- ç®¡ç†UIï¼šç®¡ç†è€…ONã®æ™‚ã ã‘ display:grid -->
      <div id="adminControls" class="panel" style="display:none">
        <div class="card">
          <h3>è¨­å®š</h3>
          <div class="grid-3">
            <div class="field">
              <label>æ¼”å¥ï¼ˆåˆ†ï¼‰</label>
              <input type="number" id="perfMin" min="1" max="120" value="15" />
            </div>
            <div class="field">
              <label>è»¢æ›ï¼ˆåˆ†ï¼‰</label>
              <input type="number" id="setupMin" min="1" max="60" value="5" />
            </div>
            <div class="field switch">
              <input type="checkbox" id="loopMode" checked />
              <label for="loopMode">äº¤äº’ãƒ«ãƒ¼ãƒ—</label>
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px">
            <button id="applyBtn" class="btn-primary">è¨­å®šã‚’ä¿å­˜</button>
            <button id="resetBtn" class="btn-danger">ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <button id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
          <button id="pauseBtn">ä¸€æ™‚åœæ­¢</button>
        </div>
        <div>
          <button id="skipBtn">æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã¸ã‚¹ã‚­ãƒƒãƒ—</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="loginModal" class="modal" aria-modal="true" role="dialog">
    <div class="sheet">
      <h3 style="margin:0 0 10px;color:#cbd5e1;font-size:14px">åˆè¨€è‘‰ï¼ˆã²ã‚‰ãŒãªï¼‰</h3>
      <div style="display:grid;grid-template-columns:1fr auto;gap:10px">
        <input type="text" id="passphrase" placeholder="ã²ã‚‰ãŒãªã§å…¥åŠ›" />
        <button id="doLoginBtn" class="btn-primary">ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ON</button>
      </div>
      <div class="muted" style="margin-top:8px">* 2æ™‚é–“ã§è‡ªå‹•å¤±åŠ¹ã—ã¾ã™</div>
    </div>
  </div>

  <!-- Firebase v9+ modular SDK (ESM via CDN) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref, onValue, update, set, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    // ==== Firebase è¨­å®šï¼ˆã‚ãªãŸã®å€¤ã®ã¾ã¾ã§OKï¼‰ ====
    const firebaseConfig = {
      apiKey: "AIzaSyDo1vyMmbYQHJQZ8pjKapcwR-6H0-c_VsU",
      authDomain: "sync-timer-c3d72.firebaseapp.com",
      databaseURL: "https://sync-timer-c3d72-default-rtdb.firebaseio.com",
      projectId: "sync-timer-c3d72",
      storageBucket: "sync-timer-c3d72.firebasestorage.app",
      messagingSenderId: "788466695958",
      appId: "1:788466695958:web:e57ee07c59ff2d686f9a37"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // ==== DOM ====
    const phaseBadge = document.getElementById('phaseBadge');
    const timeText   = document.getElementById('timeText');
    const subText    = document.getElementById('subText');
    const authState  = document.getElementById('authState');
    const loginBtn   = document.getElementById('loginBtn');
    const logoutBtn  = document.getElementById('logoutBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');

    const loginModal = document.getElementById('loginModal');
    const doLoginBtn = document.getElementById('doLoginBtn');
    const passphraseInput = document.getElementById('passphrase');

    const adminControls = document.getElementById('adminControls');
    const perfMin = document.getElementById('perfMin');
    const setupMin = document.getElementById('setupMin');
    const loopMode = document.getElementById('loopMode');

    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const resetBtn = document.getElementById('resetBtn');
    const skipBtn  = document.getElementById('skipBtn');
    const applyBtn = document.getElementById('applyBtn');

    // ==== Utils ====
    const getClientId=()=>{let id=localStorage.getItem('clientId'); if(!id){id=(crypto.randomUUID?crypto.randomUUID():Math.random().toString(36).slice(2)); localStorage.setItem('clientId',id);} return id;};
    const CLIENT_ID = getClientId();
    const toHiragana = s => s.normalize('NFKC').replace(/[ã‚¡-ãƒ³]/g, ch => String.fromCharCode(ch.charCodeAt(0)-0x60)).replaceAll(' ','').replaceAll('ã€€','').toLowerCase();
    const hex = buf => Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');

    let serverOffset=0; onValue(ref(db,'.info/serverTimeOffset'), s => { serverOffset = s.val() || 0; });
    const serverNow = () => Date.now()+serverOffset;

    // ==== çŠ¶æ…‹ ====
    const TIMER_REF = ref(db, 'timer');
    let timer=null, isAdmin=false, sessionExp=0;

    const defaultTimer = () => ({
      status:'stopped', currentPhase:'performance', endTime:null, remainingTime: 15*60*1000,
      settings:{ performanceDuration:15*60*1000, setupDuration:5*60*1000, isLoopMode:true },
      meta:{ actor: CLIENT_ID }, lastUpdated: serverTimestamp()
    });

    const phaseLabel = p => p==='performance'?'æ¼”å¥ä¸­':'è»¢æ›ä¸­';
    const phaseClass = p => p==='performance'?'badge play':'badge setup';
    const nextPhase  = p => p==='performance'?'setup':'performance';
    const fmtMS = ms => { ms=Math.max(0,ms|0); const t=Math.floor(ms/1000); const m=String(Math.floor(t/60)).padStart(2,'0'); const s=String(t%60).padStart(2,'0'); return `${m}:${s}`; };
    const fmtClock = ts => new Date(ts).toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'});
    const durationOf=(phase,t=timer)=>phase==='performance'?(t?.settings?.performanceDuration||0):(t?.settings?.setupDuration||0);

    const render = (updateInputs=false)=>{
      if(!timer) return;
      let remain=0;
      if (timer.status==='running' && timer.endTime) remain=Math.max(0, timer.endTime - serverNow());
      else remain=timer.remainingTime || durationOf(timer.currentPhase);
      timeText.textContent = fmtMS(remain);
      phaseBadge.textContent = phaseLabel(timer.currentPhase);
      phaseBadge.className = phaseClass(timer.currentPhase);
      const np=nextPhase(timer.currentPhase), npDur=durationOf(np);
      const startAt=(timer.status==='running'&&timer.endTime)?fmtClock(timer.endTime):'â€”';
      subText.textContent = `æ¬¡: ${np==='performance'?'æ¼”å¥':'è»¢æ›'} (${fmtMS(npDur)}) ï¼ é–‹å§‹äºˆå®š: ${startAt}`;

      [startBtn,pauseBtn,resetBtn,skipBtn,applyBtn].forEach(b=>b.disabled=!isAdmin);

      if(updateInputs){
        const ae=document.activeElement;
        if(ae!==perfMin)  perfMin.value = Math.floor((timer.settings?.performanceDuration??900000)/60000);
        if(ae!==setupMin) setupMin.value= Math.floor((timer.settings?.setupDuration??300000)/60000);
        if(ae!==loopMode) loopMode.checked=!!timer.settings?.isLoopMode;
      }
    };
    onValue(TIMER_REF, snap => { timer = snap.exists()?snap.val():null; render(true); });

    // ==== ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆç®¡ç†è€…ONã§è¨­å®šUIã‚’è¡¨ç¤ºï¼‰ ====
    const openLogin=()=>{ loginModal.style.display='grid'; passphraseInput.focus(); };
    const closeLogin=()=>{ loginModal.style.display='none'; };
    const showAdmin=()=>{ isAdmin=true; adminControls.style.display='grid'; authState.textContent=`ğŸ”“ ç®¡ç†è€…: ONï¼ˆ~${fmtClock(sessionExp)}ï¼‰`; loginBtn.style.display='none'; logoutBtn.style.display='inline-block'; render(); };
    const hideAdmin=()=>{ isAdmin=false; adminControls.style.display='none'; authState.textContent='ğŸ”’ ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰: OFF'; loginBtn.style.display='inline-block'; logoutBtn.style.display='none'; render(); };

    loginBtn.addEventListener('click', openLogin);
    logoutBtn.addEventListener('click', hideAdmin);
    loginModal.addEventListener('click', e=>{ if(e.target===loginModal) closeLogin(); });

    async function sha256Hex(str){ const buf=new TextEncoder().encode(toHiragana(str)); const dig=await crypto.subtle.digest('SHA-256',buf); return hex(dig); }
    async function createSession(pass){
      const hash=await sha256Hex(pass);
      const exp=serverNow()+2*60*60*1000;
      await set(ref(db,`sessions/${CLIENT_ID}`),{hash,approved:true,expiresAt:exp});
      sessionExp=exp; closeLogin(); showAdmin();
      if(!timer) await set(TIMER_REF, defaultTimer());
    }
    doLoginBtn.addEventListener('click', async()=>{
      const pw=passphraseInput.value.trim(); if(!pw) return alert('åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      try{ await createSession(pw); passphraseInput.value=''; }catch(e){ console.error(e); alert('åˆè¨€è‘‰ãŒé•ã†ã‹ã€ãƒ«ãƒ¼ãƒ«ã«å¼¾ã‹ã‚Œã¾ã—ãŸ'); }
    });

    // ==== æ“ä½œ ====
    const write=obj=>update(TIMER_REF,{...obj,lastUpdated:serverTimestamp(),'meta/actor':CLIENT_ID});
    const cmd_start=()=>{ if(!timer) return;
      const base=(timer.status==='paused')?(timer.remainingTime||durationOf(timer.currentPhase))
               :(timer.status==='stopped')?durationOf(timer.currentPhase)
               :Math.max(0,(timer.endTime||serverNow())-serverNow());
      write({status:'running',endTime:serverNow()+base}); };
    const cmd_pause=()=>{ if(!timer) return;
      const remain=(timer.status==='running'&&timer.endTime)?Math.max(0,timer.endTime-serverNow()):(timer.remainingTime||0);
      write({status:'paused',endTime:null,remainingTime:remain}); };
    const cmd_reset=()=>{ const perf=Math.max(1,parseInt(perfMin.value||'15',10))*60000; const setup=Math.max(1,parseInt(setupMin.value||'5',10))*60000;
      set(TIMER_REF, defaultTimer()).then(()=>{ write({status:'stopped',currentPhase:'performance',endTime:null,remainingTime:perf,settings:{performanceDuration:perf,setupDuration:setup,isLoopMode:!!loopMode.checked}}); }); };
    const cmd_skip=()=>{ if(!timer) return; const np=timer.currentPhase==='performance'?'setup':'performance'; const dur=durationOf(np);
      if(timer.status==='running') write({currentPhase:np,endTime:serverNow()+dur,status:'running'}); else write({currentPhase:np,remainingTime:dur,endTime:null}); };
    const cmd_apply=()=>{ const perf=Math.max(1,parseInt(perfMin.value||'15',10))*60000; const setup=Math.max(1,parseInt(setupMin.value||'5',10))*60000; const isLoop=!!loopMode.checked;
      const obj={settings:{performanceDuration:perf,setupDuration:setup,isLoopMode:isLoop}}; if(timer && timer.status!=='running') obj.remainingTime = (timer.currentPhase==='performance'?perf:setup);
      write(obj); };

    startBtn.addEventListener('click', cmd_start);
    pauseBtn.addEventListener('click', cmd_pause);
    resetBtn.addEventListener('click', cmd_reset);
    skipBtn .addEventListener('click', cmd_skip);
    applyBtn.addEventListener('click', cmd_apply);

    // ==== è¡¨ç¤ºã¯å…¨å“¡ã§å®šæœŸæ›´æ–° ====
    setInterval(()=>{ render(false); }, 250);
    document.addEventListener('visibilitychange',()=>{ if(!document.hidden) render(false); });

    // ==== ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼ˆãƒœã‚¿ãƒ³/ã‚­ãƒ¼ Fï¼‰ ====
    async function toggleFullscreen(){
      if (!document.fullscreenElement) { try{ await document.documentElement.requestFullscreen(); }catch{} }
      else { try{ await document.exitFullscreen(); }catch{} }
    }
    fullscreenBtn.addEventListener('click', toggleFullscreen);
    document.addEventListener('keydown', e=>{ if(e.key.toLowerCase()==='f') toggleFullscreen(); });
  </script>
</body>
</html>
